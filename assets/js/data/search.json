[ { "title": "Extension Attributes in Azure AD", "url": "/posts/AAD-Extension-Properties/", "categories": "Cloud", "tags": "azure", "date": "2022-09-30 15:50:00 +0200", "snippet": "I needed to create a dynamic group in AzureAD that contained only users created in the last X number of days and I did a test with extension attributes.First an application needed to be created in Azure AD under app registrations. For some reason the example codes I found to do this in powershell did not work but it was easy enough in the portal.After the application is created we can add a new property.# ObjectID is the Application (client) ID of the application we created.New-AzureADApplicationExtensionProperty -ObjectId 6421aee036014ad0937ee5ac271eb831 -Name \"NewEmployee\" -DataType boolean -TargetObjects \"User\"Then we can set a value as a test.$UserId = \"my.testuser@ourtenant.onmicrosoft.com\"Set-AzureADUserExtension -ObjectId $UserId -ExtensionName \"extension_6421aee036014ad0937ee5ac271eb831_NewEmployee\" -ExtensionValue $falseThen to set the value on all users matching a specific SMTP domain.$allusers = Get-AzureADUser -All $true | Where-Object {$_.UserPrincipalName -like \"*@mydomain.org\"} | Where-Object {$_.ExtensionProperty.extension_6421aee036014ad0937ee5ac271eb831_NewEmployee -ne $false}$cutoverdate = (get-date).AddDays(-14)ForEach($user in $allusers) {\t$creationDate = (Get-AzureADUserExtension -ObjectId $user.UserPrincipalName).Get_Item(\"createdDateTime\")\tif([DateTime]$creationDate -gt $cutoverdate) { Set-AzureADUserExtension -ObjectId $user.UserPrincipalName -ExtensionName \"extension_6421aee036014ad0937ee5ac271eb831_NewEmployee\" -ExtensionValue $true\t\t} else { Set-AzureADUserExtension -ObjectId $user.UserPrincipalName -ExtensionName \"extension_6421aee036014ad0937ee5ac271eb831_NewEmployee\" -ExtensionValue $false }}In the dynamic rule builder in Azure AD we can then use the following to get all users were our attribute is true.user.extension_19de210501aa496ebbef77282aec382c_NewEmployee -eq true" }, { "title": "Renew certificate for NPS Azure MFA extension", "url": "/posts/renew-nps-mfa-cert/", "categories": "Windows", "tags": "azure, mfa", "date": "2022-08-29 09:19:00 +0200", "snippet": "Got a report this morning that MFA using Azure MFA extension in NPS did not work and I found a lot of Event ID 3 in the AuthZAdminCh channel. The interesting part of the error was The certificate with identifier used to sign the client assertion is expired on application. [Reason - The key used is expired.I blog post on starwind.com sent me in the right direction. Turned out to be a certificate generated during setup with a 2 year validity that had expired.The certificate is located in [Certificates - Local Computer\\Personal\\Certificates] and CN equals the tenant ID.To generate a new certificate the script AzureMfaNpsExtnConfigSetup.ps1 included in the MFA extension installation can be used. Sign in as tenant admin when prompted and press enter to keep the current tenant ID. Enter Y if you get prompted to allow NuGet.PS C:\\Program Files\\Microsoft\\AzureMfa\\Config&gt; .\\AzureMfaNpsExtnConfigSetup.ps1VERBOSE: Using the provider 'PowerShellGet' for searching packages.VERBOSE: The -Repository parameter was not specified. PowerShellGet will use all of the registered repositories.VERBOSE: Getting the provider object for the PackageManagement Provider 'NuGet'.VERBOSE: The specified Location is 'https://www.powershellgallery.com/api/v2' and PackageManagementProvider is 'NuGet'.VERBOSE: Searching repository 'https://www.powershellgallery.com/api/v2/FindPackagesById()?id='MSOnline'' for ''.VERBOSE: Total package yield:'1' for the specified package 'MSOnline'.VERBOSE: Performing the operation \"Install-Module\" on target \"Version '1.1.183.66' of module 'MSOnline'\".Untrusted repositoryYou are installing the modules from an untrusted repository. If you trust this repository, change itsInstallationPolicy value by running the Set-PSRepository cmdlet. Are you sure you want to install the modules from'PSGallery'?[Y] Yes [A] Yes to All [N] No [L] No to All [S] Suspend [?] Help (default is \"N\"): yVERBOSE: The installation scope is specified to be 'AllUsers'.VERBOSE: The specified module will be installed in 'C:\\Program Files\\WindowsPowerShell\\Modules'.Connecting to Microsoft Azure. Please sign on as a tenant administrator.Starting Azure MFA NPS Extension Configuration Script Tenant ID currently registered with Azure MFA NPS Extension is: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxxEnter new Tenant ID to change or press Enter to keep the current value:Generating client certificateThumbprint Subject---------- -------AABBCCDD1122334455AABBCCDD1122334455AABB CN=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx, OU=Microsoft NPS ExtensionClient Certificate successfully generatedClient Certificate associated with Service Principal: yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyyStarting registry updatesCompleted registry updatesClient certificate : CN=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx, OU=Microsoft NPS Extension successfully associated with Azure MFA NPS Extension for Tenant ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxxGranting certificate private key access to NETWORK SERVICESuccessfully granted to NETWORK SERVICERestarting Network Policy Server (ias) serviceWARNING: Waiting for service 'Network Policy Server (ias)' to stop...WARNING: Waiting for service 'Network Policy Server (ias)' to stop...Configuration complete. Press Enter to continue...:" }, { "title": "Broken NTFS permissions after migration", "url": "/posts/broken-ntfs-permissions/", "categories": "Windows", "tags": "ntfs", "date": "2022-08-10 18:20:00 +0200", "snippet": "After migrating a fileshare using DFS replication I noticed that permissions were acting strange. When creating folders at the new location they did not inherit permissions from the root folder if created using the smb share. When folders were created locally they worked just fine.Solution was to add a random permission to the root folder (used my admin account in this case). When the added permission had propagated down to all subfolder and files it was removed again.Remember to not check “Replace all child object permission entries with inheritable permission entries from this object” when doing this since that can wipe out any explicit permissions set on subfolder and files.References: https://www.sys-manage.com/Blog/how-share-ntfs-permissions-and-inheritance-actually-work#corrupted-ntfs-permission-inheritance" }, { "title": "Setup Jekyll in WSL", "url": "/posts/jekyll-setup-wsl/", "categories": "Windows", "tags": "wsl, jekyll", "date": "2022-08-04 19:03:00 +0200", "snippet": "This attempt at a blog is done with Jekyll and the Chirpy theme.After following the guide for chirpy and downloading a copy of the repository I used WSL for the local jekyll installation.sudo apt-get install -y ruby-full build-essential zlib1g-devecho '# Install Ruby Gems to ~/gems' &gt;&gt; ~/.bashrcecho 'export GEM_HOME=\"$HOME/gems\"' &gt;&gt; ~/.bashrcecho 'export PATH=\"$HOME/gems/bin:$PATH\"' &gt;&gt; ~/.bashrcsource ~/.bashrcgem install bundlergem install jekyll --version 3.9.2cd repositoryfolderbundle exec jekyll serve" }, { "title": "Hidden settings in Telias Sagemcom F@st 5370e", "url": "/posts/telia-sagemcom/", "categories": "Network", "tags": "telia, sagemcom", "date": "2021-11-08 20:05:00 +0100", "snippet": "I got fiber from Telia installed this year and a router from Sagemcom was included. I am mostly happy with it but there are some functions missing or in some cases hidden.Since I run my own DNS resolver with Pi-hole I want the IP for that local server to be served to my clients instead of the ISP provided nameservers.I also wanted to setup a guest network trying to get some basic segmentation startedThankfully both settings for DNS and guest network could be accessed through hidden pages in the web interface. Also found settings for parental control but thats nothing I am interested in.Guest network: https://192.168.1.1/0.1/gui/#/wifi/2.4GHz/guest/basicDNS settings: https://192.168.1.1/0.1/gui/#/mybox/dns/serverParental control: http://192.168.1.1/0.1/gui/#/access-control/parental-control/planning http://192.168.1.1/0.1/gui/#/access-control/parental-control/filteringThere is also the possibility to access settings with XPATH but I haven’t used that. Would like a way to add static routes so might explore this more in the future.Some sources for more reading: https://github.com/wuseman/SAGEMCOM-FAST-5370e-TELIA https://krishnendu.com/telia-se-router-sagemcom-f-st-5370e-mod/ https://krishnendu.com/part-2-telia-se-router-sagemcom-f-st-5370e-mod/ https://krishnendu.com/part-3-telia-se-router-sagemcom-f-st-5370e-mod-finale/" }, { "title": "WVD presentation at SWVDUG", "url": "/posts/wvd-presentation/", "categories": "Desktop Virtualization", "tags": "azure, wvd", "date": "2021-03-21 18:02:00 +0100", "snippet": "My presentation from the SWVDUG virtual meetup is online at https://www.youtube.com/watch?v=ciXTQEc1GW4. The presentation is in Swedish." } ]
